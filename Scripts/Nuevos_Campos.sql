
ALTER TABLE DEUDA_CORPORATIVO ADD F_DUMP_OAC DATE;

UPDATE DEUDA_CORPORATIVO SET F_DUMP_OAC =SYSDATE;

ALTER TABLE DEUDA_CORPORATIVO ADD SEGMENTO_CORP VARCHAR2(50);
ALTER TABLE DEUDA_CORPORATIVO ADD EJECUTIVO VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD SUPERVISOR VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD SECTOR VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD REGION_CAE VARCHAR2(50);
ALTER TABLE DEUDA_CORPORATIVO ADD DIRECCION VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD SEGMENTO VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD SUB_SEGMENTO VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD OPERADORES VARCHAR2(20);
ALTER TABLE DEUDA_CORPORATIVO ADD GRUPO VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD GESTOR VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD NOMBRE_CARTERA VARCHAR2(200);
ALTER TABLE DEUDA_CORPORATIVO ADD ESTADO VARCHAR2(200);
ALTER TABLE DEUDA_CORPORATIVO ADD REGION VARCHAR2(20);
ALTER TABLE DEUDA_CORPORATIVO ADD DEPARTAMENTO VARCHAR2(200);
ALTER TABLE DEUDA_CORPORATIVO ADD PROVINCIA VARCHAR2(200);
ALTER TABLE DEUDA_CORPORATIVO ADD DISTRITO VARCHAR2(200);
ALTER TABLE DEUDA_CORPORATIVO ADD TOP VARCHAR2(100);
ALTER TABLE DEUDA_CORPORATIVO ADD PLAZO_ESPECIAL VARCHAR2(20);
ALTER TABLE DEUDA_CORPORATIVO ADD "1. Por vencer" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "2. 1 a 30" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "3. 31 a 60" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "4. 61 a 90" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "5. 91 a 120" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "6. 121 a 150" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "7. 151 a 210" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "8. 211 a 364" NUMBER;
ALTER TABLE DEUDA_CORPORATIVO ADD "9. 365 a mas" NUMBER;
COMMIT;
MERGE INTO DEUDA_CORPORATIVO D
USING  (SELECT X.* FROM ( SELECT A.RUC,A.TIPO_CORPORATIVO,ROW_NUMBER() OVER (PARTITION BY A.RUC ORDER BY A.F_DUMP DESC) RN FROM OPERACION.ESCALERA_CORPORATIVO_2 A) X WHERE X.RN=1) B
ON (D.RUC = B.RUC)
WHEN MATCHED THEN UPDATE SET
  D.SEGMENTO_CORP = B.TIPO_CORPORATIVO;

UPDATE DEUDA_CORPORATIVO SET SEGMENTO_CORP = 'NO CARTERIZADO' WHERE SEGMENTO_CORP IS NULL;

MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT*FROM OPERACION.IRC_NOTIF_BASE_CAE WHERE SECTOR NOT IN ('GOBIERNO'))CAE ON (CAE.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET  
  D.EJECUTIVO=CAE.EJECUTIVO,
  D.SUPERVISOR=CAE.SUPERVISOR,
  D.SECTOR=CAE.SECTOR,
  D.REGION_CAE=CAE.REGION;

MERGE INTO DEUDA_CORPORATIVO D
USING C13023.PIRAMIDE_NEW@DBL_DWO P ON (P.NUMDOC = D.RUC )
WHEN MATCHED THEN UPDATE SET   
  D.DIRECCION=P.DIRECCION,
  D.SEGMENTO=P.SEGMENTO,
  D.SUB_SEGMENTO=P.SUB_SEGMENTO;

MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT T.* FROM (SELECT DISTINCT RUC,SECTOR,ROW_NUMBER() OVER (PARTITION BY RUC ORDER BY F_DUMP DESC)RN
FROM USRIRC.IRC_NOTIF_BL_P_RAW@DBL_DWO )T WHERE RN=1 AND SECTOR ='OPERADORES') O ON (D.RUC = O.RUC )
WHEN MATCHED THEN UPDATE SET 
   D.OPERADORES =O.SECTOR;
   
UPDATE DEUDA_CORPORATIVO SET OPERADORES = 'NO OPERADOR' WHERE OPERADORES IS NULL;

MERGE INTO DEUDA_CORPORATIVO D
USING C13023.ICC_GRUPOS_ECONOMICOS@DBL_DWO G ON (G.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET 
  D.GRUPO = G.GRUPO;

UPDATE DEUDA_CORPORATIVO SET GRUPO = 'SIN GRUPO' WHERE GRUPO IS NULL;



MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT X.* FROM (SELECT  RUC_DNI ,NOMBRE_CARTERA, GESTOR ,
ROW_NUMBER() OVER (PARTITION BY RUC_DNI ORDER BY SEGMENTO DESC,FECHA DESC,NOMBRE_CARTERA DESC,GESTOR DESC)RN 
FROM OPERACION.IRC_MSQL_LIQ_CONSOLIDADOS WHERE (CASE WHEN AFILIADOS_AFP IS NOT NULL THEN AFILIADOS_AFP ELSE TIPO_CORPORATIVO END) NOT IN ('NO CARTERIZADO'))X
WHERE RN=1) A ON ( A.RUC_DNI = D.RUC)
WHEN MATCHED THEN UPDATE SET 
     D.NOMBRE_CARTERA=A.NOMBRE_CARTERA,
     D.GESTOR = A.GESTOR;


MERGE INTO (SELECT * FROM DEUDA_CORPORATIVO WHERE NOMBRE_CARTERA IS NULL)  D
USING  (SELECT X.* FROM (SELECT  CUST_ACCOUNT ,NOMBRE_CARTERA, GESTOR ,
ROW_NUMBER() OVER (PARTITION BY CUST_ACCOUNT ORDER BY SEGMENTO DESC,FECHA DESC,NOMBRE_CARTERA DESC,GESTOR DESC)RN 
FROM OPERACION.IRC_MSQL_LIQ_CONSOLIDADOS WHERE (CASE WHEN AFILIADOS_AFP IS NOT NULL THEN AFILIADOS_AFP ELSE TIPO_CORPORATIVO END)='NO CARTERIZADO')X
WHERE RN=1) A ON ( A.CUST_ACCOUNT = D.NRO_CUENTA)
WHEN MATCHED THEN UPDATE SET 
     D.NOMBRE_CARTERA=A.NOMBRE_CARTERA,
     D.GESTOR = A.GESTOR;

UPDATE DEUDA_CORPORATIVO D
SET   
"1. Por vencer" =(CASE WHEN D.TRAMO_VENCIMIENTO='1. Por vencer' THEN D.SALDO_SOLES  ELSE 0 END),
"2. 1 a 30" =(CASE WHEN D.TRAMO_VENCIMIENTO='2. 1 a 30' THEN D.SALDO_SOLES  ELSE 0 END),
"3. 31 a 60" =(CASE WHEN D.TRAMO_VENCIMIENTO='3. 31 a 60' THEN D.SALDO_SOLES  ELSE 0 END),
"4. 61 a 90" =(CASE WHEN D.TRAMO_VENCIMIENTO='4. 61 a 90' THEN D.SALDO_SOLES  ELSE 0 END),
"5. 91 a 120" =(CASE WHEN D.TRAMO_VENCIMIENTO='5. 91 a 120' THEN D.SALDO_SOLES  ELSE 0 END),
"6. 121 a 150" =(CASE WHEN D.TRAMO_VENCIMIENTO='6. 121 a 150' THEN D.SALDO_SOLES  ELSE 0 END),
"7. 151 a 210"  =(CASE WHEN D.TRAMO_VENCIMIENTO='7. 151 a 210' THEN D.SALDO_SOLES ELSE 0 END),
"8. 211 a 364"  =(CASE WHEN D.TRAMO_VENCIMIENTO='8. 211 a 364' THEN D.SALDO_SOLES  ELSE 0 END),
"9. 365 a mas"  =(CASE WHEN D.TRAMO_VENCIMIENTO='9. 365 a mas' THEN D.SALDO_SOLES  ELSE 0 END);


MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT C.CUENTA_CD ,UPPER(Z.ZONAL) REGION, C.DEPARTAMENTO_CUENTA_DESC, C.PROVINCIA_CUENTA_DESC,C. DISTRITO_CUENTA_DESC,ESTADO_CUENTA_DESC FROM DWHDS.DS_CUENTAS@DBL_DWO C ,RC_ZONALES Z
WHERE UPPER(C.DEPARTAMENTO_CUENTA_DESC)= UPPER(Z.DEPARTAMENTO))U ON (U.CUENTA_CD = D.CUSTOMER_ID )
WHEN MATCHED THEN UPDATE SET 
  D.REGION=UPPER(U.REGION),
  D.DEPARTAMENTO = UPPER(U.DEPARTAMENTO_CUENTA_DESC),
  D.PROVINCIA = UPPER(U.PROVINCIA_CUENTA_DESC),
  D.DISTRITO = UPPER(U.DISTRITO_CUENTA_DESC),
  D.ESTADO=U.ESTADO_CUENTA_DESC;


DROP TABLE TOP_CORPORATIVO PURGE;

CREATE TABLE TOP_CORPORATIVO AS( 
SELECT /*+ parallel(8)*/ 
R.RUC,
(CASE WHEN ROW_NUMBER() OVER(PARTITION BY SEGMENTO_CORP ORDER BY SUM(SALDO_SOLES)DESC)<='20' THEN '1. [1-20]'
      WHEN ROW_NUMBER() OVER(PARTITION BY SEGMENTO_CORP ORDER BY SUM(SALDO_SOLES)DESC)BETWEEN 21 AND 100  THEN '2. [21-100]'
      WHEN ROW_NUMBER() OVER(PARTITION BY SEGMENTO_CORP ORDER BY SUM(SALDO_SOLES)DESC)BETWEEN 101 AND 1000  THEN '3. [101-1000]'
      WHEN ROW_NUMBER() OVER(PARTITION BY SEGMENTO_CORP ORDER BY SUM(SALDO_SOLES)DESC)>1000  THEN '4. [>1000]'END) AS TOP

FROM(SELECT D.RUC,D.SEGMENTO_CORP,D.SALDO_SOLES FROM DEUDA_CORPORATIVO D WHERE OBS='DEUDA')R GROUP BY R.RUC,R.SEGMENTO_CORP);

MERGE INTO DEUDA_CORPORATIVO D
USING TOP_CORPORATIVO U ON (U.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET 
  D.TOP = U.TOP;

ALTER TABLE DEUDA_CORPORATIVO ADD WHITELIST VARCHAR(20);

MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT T.* FROM (SELECT DISTINCT RUC,'SI'WHITELIST ,ROW_NUMBER() OVER (PARTITION BY RUC ORDER BY F_DUMP DESC)RN
FROM USRIRC.IRC_NOTIF_BL_P_RAW@DBL_DWO )T WHERE RN=1) U ON (U.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET 
  D.WHITELIST = U.WHITELIST;

UPDATE DEUDA_CORPORATIVO SET WHITELIST = 'NO' WHERE WHITELIST IS NULL;

MERGE INTO DEUDA_CORPORATIVO D
USING (SELECT *FROM C18571.CORP_CLIENTES_ESPECIALES WHERE FECHA_FIN IS NULL) P ON (P.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET D.PLAZO_ESPECIAL=P.PLAZO;

ALTER TABLE DEUDA_CORPORATIVO ADD PRIORIDAD NUMBER;

DROP TABLE PRIORIDAD_4 PURGE;

CREATE TABLE PRIORIDAD_4 AS(
SELECT  /*+ parallel(2)*/  R.RUC,ROW_NUMBER() OVER(ORDER BY PRIO1 DESC,PRIO2 DESC,PRIO3 DESC,PRIO4 DESC,DEUDA_SOLES DESC) AS PRIORIDAD FROM
(SELECT RUC ,
(SUM("1. Por vencer")/SUM(SALDO_SOLES))PRIO4,
((SUM("2. 1 a 30")+SUM("3. 31 a 60"))/SUM(SALDO_SOLES))PRIO3,
((SUM("4. 61 a 90")+SUM("5. 91 a 120"))/SUM(SALDO_SOLES))PRIO2,
((SUM("6. 121 a 150")+SUM("7. 151 a 210")+SUM("8. 211 a 364")+SUM("9. 365 a mas"))/SUM(SALDO_SOLES))PRIO1,
SUM(SALDO_SOLES)DEUDA_SOLES
 FROM DEUDA_CORPORATIVO
 WHERE OPERADORES='NO OPERADOR'
 AND OBS='DEUDA'
 GROUP BY RUC)R);

MERGE INTO DEUDA_CORPORATIVO D
USING PRIORIDAD_4 U ON (U.RUC = D.RUC )
WHEN MATCHED THEN UPDATE SET 
  D.PRIORIDAD = U.PRIORIDAD;

ALTER TABLE DEUDA_CORPORATIVO ADD F_DUMP DATE;

UPDATE DEUDA_CORPORATIVO SET F_DUMP =SYSDATE;

GRANT SELECT ON DEUDA_CORPORATIVO TO C13911;
GRANT SELECT ON DEUDA_CORPORATIVO TO C10533;
GRANT SELECT ON DEUDA_CORPORATIVO TO C15735;